---
title: "HIC Analysis Perceptual data (manuscript)"
author: "Alex Gould"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
    number_sections: yes
    latex_engine: xelatex
  rmarkdown::pdf_document:
    extra_dependencies: float
    toc: yes
html_document:
  toc: yes
toc_float: yes
---

# Setup

First let us set up the R environment:

## Global options

```{r global options, include = TRUE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      error = FALSE,
                      eval = TRUE,
                      dev = c('pdf', 'png'),
                      width = 60,
                      fig.align = 'center', 
                      fig.height = 10, 
                      fig.width = 10, 
                      fig.dpi = 300,
                      fig.pos = "!H",
                      dpi = 300,
                      out.extra = "",
                      message = FALSE, 
                      cache = FALSE,
                      #pdf.options(family = "serif"),
                      fig.path='figs/rmd/'
                      ) 
```

## Library 

```{r Library}
library(xlsx)
library(rstudioapi)
library(tidyverse)
library(jmv)
library(ggtext)
library(ggpubr)
library(gridtext) 
library(rstatix)
library(scales)
library(grid)
```

## Parameters

``` {r Parameters}
data_dir     = "..."
analysis_dir = "..."
pw_message   = "..."
font         = element_text(family = "serif")
group_cols   = c("Control" = "#0099CC", "Patient" = "#FF9900",
                 "Tolerant" = "#005900", "Intolerant" = "#ff2c15")
```

### Figure parameters 

First, create custom theme to use throughout:

```{r figure_theme}
## create custom theme
theme_ag <- function(){

  theme_classic() %+replace%
    
    theme(
      text = font,
      axis.text.y  = element_text(size = 12, margin = margin(r = 3)),
      axis.title.y = element_text(size = 16, angle = 90, vjust = 2),
      axis.text.x  = element_text(size = 16, margin = margin(r = 3)),
      axis.title.x = element_blank(),
      legend.position = "none"
      )
}
```

Fix for `stat_compare_means()` function to allow Times New Roman font. Thank you https://stackoverflow.com/questions/77346644/stat-compare-means-unable-to-change-font-family-when-using-comparisons-argu 

```{r stat_compare_means_fix}
fixed_call <- quote(ggsignif::geom_signif(comparisons = comparisons, 
                                          y_position = label.y, 
                                          test = method, test.args = method.args, 
                                          step_increase = step.increase, 
                                          size = bracket.size, textsize = 6, color = color, 
                                          map_signif_level = map_signif_level, 
                                          tip_length = tip.length, data = data,
                                          vjust = vjust, ...))

scm <- as.list(ggpubr::stat_compare_means)
scm[[26]][[2]][[3]][[13]] <- fixed_call
stat_compare_means <- function(...) {
  ggp <- getNamespace('ggpubr')
  .method_info <- ggp$.method_info
  .add_item <- ggp$.add_item
  .is_p.signif_in_mapping <- ggp$.is_p.signif_in_mapping
  .is_empty <- ggp$.is_empty
  do.call(as.function(scm), list(...), quote = FALSE)
}
```

## Load Data
Next we load in the data:

```{r load_data}
## data loaded here...
```

# Patients and Controls

## Rating of Perceived Exertion

### Descriptives

```{r RPE_descriptives_class}
jmv::descriptives(
    formula = RPE_0 + RPE_phase1 + RPE_phase2 + RPE_term ~ Class,
    data = dat,
    iqr = TRUE,
    sw = TRUE)
```

### Test of Difference

parametric data:

```{r RPE_parametric_class}
jmv::ttestIS(
    formula = RPE_phase1 + RPE_phase2 ~ Class,
    data = dat,
    vars = vars(RPE_phase1, RPE_phase2),
    eqv = TRUE,
    effectSize = TRUE)
```

non-parametric data:

```{r RPE_non-parametric_class}
jmv::ttestIS(
    formula = RPE_0 + RPE_term ~ Class,
    data = dat,
    vars = vars(RPE_0, RPE_term),
    students = FALSE,
    mann = TRUE,
    effectSize = TRUE)
```

### Figure

#### Rest

plot rest figure:  
non-parametric

``` {r RPE_rest_class_fig, fig.height = 5, fig.width = 6}
set.seed(123)
RPE_rest_class_p <- ggplot(dat, aes(x = Class, y = RPE_0)) +
  geom_jitter(aes(color = Class), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "") +
  scale_y_continuous(breaks = seq(6, 20, 2), 
                     limits = c(5, 20)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Patient", "Control")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2,
                     label.y = 19) +
  theme_ag()

## view figure
RPE_rest_class_p 
```

#### Phase 1

plot delta Phase 1 figure:  
parametric

``` {r RPE_phase1_class_fig, fig.height = 5, fig.width = 6}
set.seed(123)
RPE_phase1_class_p <- ggplot(dat, aes(x = Class, y = RPE_phase1)) +
  geom_jitter(aes(color = Class), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = mean, 
               geom = "point", 
               color = "black",
               size = 5,
               show.legend = FALSE) +
  stat_summary(fun.data = mean_sd, 
               geom = "errorbar", 
               color = "black",
               width = 0.3,
               size = 1.0,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "Δ") +
  scale_y_continuous(breaks = seq(0, 12, 2), 
                     limits = c(0, 13)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Patient", "Control")),
                     method = "t.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) + 
  theme_ag()

## view figure
RPE_phase1_class_p
```

#### Phase 2

plot delta Phase 2 figure:  
parametric

``` {r RPE_phase2_class_fig, fig.height = 5, fig.width = 6}
set.seed(123)
RPE_phase2_class_p <- ggplot(dat, aes(x = Class, y = RPE_phase2)) +
  geom_jitter(aes(color = Class), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  stat_summary(fun = mean, 
               geom = "point", 
               color = "black",
               size = 5,
               show.legend = FALSE) +
  stat_summary(fun.data = mean_sd, 
               geom = "errorbar", 
               color = "black",
               width = 0.3,
               size = 1.0,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "Δ") +
  scale_y_continuous(breaks = seq(-8, 4, 2), 
                     limits = c(-8, 5)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Patient", "Control")),
                     method = "t.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) + 
  theme_ag()

## view figure
RPE_phase2_class_p
```

#### Termination

plot termination figure:  
non-parametric
``` {r RPE_termination_class_fig, fig.height = 5, fig.width = 6}
set.seed(123)
RPE_term_class_p <- ggplot(dat, aes(x = Class, y = RPE_term)) +
  geom_jitter(aes(color = Class), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "") +
  scale_y_continuous(breaks = seq(6, 20, 2), 
                     limits = c(6, 21)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Patient", "Control")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) +
  theme_ag()

## view figure
RPE_term_class_p 
```

## Thermal Comfort

### Descriptives

```{r TC_descriptives_class}
jmv::descriptives(
    formula = TC_0 + TC_phase1 + TC_phase2 + TC_term ~ Class,
    data = dat,
    iqr = TRUE,
    sw = TRUE)
```

### Test of Difference

parametric data:

```{r TC_parametric_class}
jmv::ttestIS(
    formula = TC_phase2 ~ Class,
    data = dat,
    vars = TC_phase2,
    eqv = TRUE,
    effectSize = TRUE)
```

non-parametric data:

```{r TC_non-parametric_class}
jmv::ttestIS(
    formula = TC_0 + TC_phase2 + TC_term ~ Class,
    data = dat,
    vars = vars(TC_0, TC_phase2, TC_term),
    students = FALSE,
    mann = TRUE,
    effectSize = TRUE)
```

### Figure

#### Rest

plot rest figure:  
non-parametric
``` {r TC_rest_class_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TC_rest_class_p <- ggplot(dat, aes(x = Class, y = TC_0)) +
  geom_jitter(aes(color = Class), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "") +
  scale_y_continuous(breaks = seq(1, 5, 0.5),
                     limits = c(0.5, 5)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Patient", "Control")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2,
                     label.y = 4.5) +
  theme_ag()

## view figure
TC_rest_class_p 
```

#### Phase 1

plot delta Phase 1 figure:  
non-parametric

``` {r TC_phase1_class_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TC_phase1_class_p <- ggplot(dat, aes(x = Class, y = TC_phase1)) +
  geom_jitter(aes(color = Class), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "Δ") +
  scale_y_continuous(breaks = seq(0, 3.5, 0.5), 
                     limits = c(0, 3.7)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Patient", "Control")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) + 
  theme_ag()

## view figure
TC_phase1_class_p
```

#### Phase 2

plot delta Phase 2 figure:  
parametric

``` {r TC_phase2_class_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TC_phase2_class_p <- ggplot(dat, aes(x = Class, y = TC_phase2)) +
  geom_jitter(aes(color = Class), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "Δ") +
  scale_y_continuous(breaks = seq(-2.0, 1.5, 0.5), 
                     limits = c(-2.0, 1.7)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Patient", "Control")),
                     method = "t.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) + 
  theme_ag()

## view figure
TC_phase2_class_p
```

#### Termination

plot termination figure:  
non-parametric

``` {r TC_termination_class_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TC_term_class_p <- ggplot(dat, aes(x = Class, y = TC_term)) +
  geom_jitter(aes(color = Class), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "") +
  scale_y_continuous(breaks = seq(1, 5, 0.5), 
                     limits = c(0.5, 5.4)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Patient", "Control")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) +
  theme_ag()

## view figure
TC_term_class_p 
```


## Thermal Sensation

### Descriptives

```{r TS_descriptives_class}
jmv::descriptives(
    formula = TS_0 + TS_phase1 + TS_phase2 + TS_term ~ Class,
    data = dat,
    iqr = TRUE,
    sw = TRUE)
```

### Test of Difference

non-parametric data:

```{r TS_non-parametric_class}
jmv::ttestIS(
    formula = TS_0 + TS_phase1 + TS_phase2 + TS_term ~ Class,
    data = dat,
    vars = vars(TS_0, TS_phase1, TS_phase2, TS_term),
    students = FALSE,
    mann = TRUE,
    effectSize = TRUE)
```

### Figure

#### Rest

plot rest figure:  
non-parametric
``` {r TS_rest_class_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TS_rest_class_p <- ggplot(dat, aes(x = Class, y = TS_0)) +
  geom_jitter(aes(color = Class), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "") +
  scale_y_continuous(breaks = seq(5, 13, 1),
                     limits = c(5, 13)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Patient", "Control")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2,
                     label.y = 12) +
  theme_ag()

## view figure
TS_rest_class_p 
```

#### Phase 1

plot delta Phase 1 figure:  
non-parametric

``` {r TS_phase1_class_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TS_phase1_class_p <- ggplot(dat, aes(x = Class, y = TS_phase1)) +
  geom_jitter(aes(color = Class), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "Δ") +
  scale_y_continuous(breaks = seq(0, 6, 1), 
                     limits = c(0, 6.5)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Patient", "Control")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) + 
  theme_ag()

#view figure
TS_phase1_class_p
```

#### Phase 2

plot delta Phase 2 figure:  
non-parametric

``` {r TS_phase2_class_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TS_phase2_class_p <- ggplot(dat, aes(x = Class, y = TS_phase2)) +
  geom_jitter(aes(color = Class), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "Δ") +
  scale_y_continuous(breaks = seq(-4, 2, 1), 
                     limits = c(-4, 2.5)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Patient", "Control")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) + 
  theme_ag()

## view figure
TS_phase2_class_p
```

#### Termination

plot termination figure:  
non-parametric
``` {r TS_termination_class_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TS_term_class_p <- ggplot(dat, aes(x = Class, y = TS_term)) +
  geom_jitter(aes(color = Class), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "") +
  scale_y_continuous(breaks = seq(5, 13, 1), 
                     limits = c(5, 13.5)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Patient", "Control")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) +
  theme_ag()

## view figure
TS_term_class_p 
```


# Heat Tolerant and Intolerant

## Rating of Perceived Exertion

### Descriptives

```{r RPE_descriptives_Outcome}
jmv::descriptives(
    formula = RPE_0 + RPE_phase1 + RPE_phase2 + RPE_term ~ Outcome,
    data = dat,
    iqr = TRUE,
    sw = TRUE)
```

### Test of Difference

parametric data:

```{r RPE_parametric_Outcome}
jmv::ttestIS(
    formula = RPE_phase1 + RPE_phase2 ~ Outcome,
    data = dat,
    vars = vars(RPE_phase1, RPE_phase2),
    eqv = TRUE,
    effectSize = TRUE)
```

non-parametric data:

```{r RPE_non-parametric_Outcome}
jmv::ttestIS(
    formula = RPE_0 + RPE_term ~ Outcome,
    data = dat,
    vars = vars(RPE_0, RPE_term),
    students = FALSE,
    mann = TRUE,
    effectSize = TRUE)
```

### Figure

#### Rest

plot rest figure:  
non-parametric

``` {r RPE_rest_Outcome_fig, fig.height = 5, fig.width = 6}
set.seed(123)
RPE_rest_Outcome_p <- ggplot(dat, aes(x = Outcome, y = RPE_0)) +
  geom_jitter(aes(color = Outcome), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "") +
  scale_y_continuous(breaks = seq(6, 20, 2), 
                     limits = c(5.7, 20)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Tolerant", "Intolerant")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2,
                     label.y = 19) +
  theme_ag()

## view figure
RPE_rest_Outcome_p 
```

#### Phase 1

plot delta Phase 1 figure:  
parametric

``` {r RPE_phase1_Outcome_fig, fig.height = 5, fig.width = 6}
set.seed(123)
RPE_phase1_Outcome_p <- ggplot(dat, aes(x = Outcome, y = RPE_phase1)) +
  geom_jitter(aes(color = Outcome), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = mean, 
               geom = "point", 
               color = "black",
               size = 5,
               show.legend = FALSE) +
  stat_summary(fun.data = mean_sd, 
               geom = "errorbar", 
               color = "black",
               width = 0.3,
               size = 1.0,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "Δ") +
  scale_y_continuous(breaks = seq(0, 12, 2), 
                     limits = c(0, 13)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Tolerant", "Intolerant")),
                     method = "t.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) + 
  theme_ag()

## view figure
RPE_phase1_Outcome_p
```

#### Phase 2

plot delta Phase 2 figure:  
parametric

``` {r RPE_phase2_Outcome_fig, fig.height = 5, fig.width = 6}
set.seed(123)
RPE_phase2_Outcome_p <- ggplot(dat, aes(x = Outcome, y = RPE_phase2)) +
  geom_jitter(aes(color = Outcome), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  stat_summary(fun = mean, 
               geom = "point", 
               color = "black",
               size = 5,
               show.legend = FALSE) +
  stat_summary(fun.data = mean_sd, 
               geom = "errorbar", 
               color = "black",
               width = 0.3,
               size = 1.0,
               show.legend = FALSE) +
    labs(x = "Group",
         y = "Δ") +
  scale_y_continuous(breaks = seq(-8, 4, 2), 
                     limits = c(-8, 5)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Tolerant", "Intolerant")),
                     method = "t.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) + 
  theme_ag()

## view figure
RPE_phase2_Outcome_p
```

#### Termination

plot termination figure:  
non-parametric
``` {r RPE_termination_Outcome_fig, fig.height = 5, fig.width = 6}
set.seed(123)
RPE_term_Outcome_p <- ggplot(dat, aes(x = Outcome, y = RPE_term)) +
  geom_jitter(aes(color = Outcome), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "") +
  scale_y_continuous(breaks = seq(6, 20, 2), 
                     limits = c(6, 21.3)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Tolerant", "Intolerant")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) +
  theme_ag()

## view figure
RPE_term_Outcome_p 
```


## Thermal Comfort

### Descriptives

```{r TC_descriptives_Outcome}
jmv::descriptives(
    formula = TC_0 + TC_phase1 + TC_phase2 + TC_term ~ Outcome,
    data = dat,
    iqr = TRUE,
    sw = TRUE)
```

### Test of Difference

non-parametric data:

```{r TC_non-parametric_Outcome}
jmv::ttestIS(
    formula = TC_0 + TC_phase1 + TC_phase2 + TC_term ~ Outcome,
    data = dat,
    vars = vars(TC_0, TC_phase1, TC_phase2, TC_term),
    students = FALSE,
    mann = TRUE,
    effectSize = TRUE)
```

### Figure

#### Rest

plot rest figure:  
non-parametric

``` {r TC_rest_Outcome_fig, fig.height = 5, fig.width = 6}
set.seed(1234)
TC_rest_Outcome_p <- ggplot(dat, aes(x = Outcome, y = TC_0)) +
  geom_jitter(aes(color = Outcome), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "") +
  scale_y_continuous(breaks = seq(1, 5, 0.5),
                     limits = c(0.5, 5)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Tolerant", "Intolerant")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2,
                     label.y = 4.5) +
  theme_ag()

## view figure
TC_rest_Outcome_p 
```

#### Phase 1

plot delta Phase 1 figure:  
non-parametric

``` {r TC_phase1_Outcome_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TC_phase1_Outcome_p <- ggplot(dat, aes(x = Outcome, y = TC_phase1)) +
  geom_jitter(aes(color = Outcome), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "Δ") +
  scale_y_continuous(breaks = seq(0, 3.5, 0.5), 
                     limits = c(0, 3.7)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Tolerant", "Intolerant")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) + 
  theme_ag()

## view figure
TC_phase1_Outcome_p
```

#### Phase 2

plot delta Phase 2 figure:  
non-parametric

``` {r TC_phase2_Outcome_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TC_phase2_Outcome_p <- ggplot(dat, aes(x = Outcome, y = TC_phase2)) +
  geom_jitter(aes(color = Outcome), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
    labs(x = "Group",
         y = "Δ") +
  scale_y_continuous(breaks = seq(-2.0, 1.5, 0.5), 
                     limits = c(-2.0, 1.9)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Tolerant", "Intolerant")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) + 
  theme_ag()

## view figure
TC_phase2_Outcome_p
```

#### Termination

plot termination figure:  
non-parametric
``` {r TC_termination_Outcome_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TC_term_Outcome_p <- ggplot(dat, aes(x = Outcome, y = TC_term)) +
  geom_jitter(aes(color = Outcome), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "") +
  scale_y_continuous(breaks = seq(1, 5, 0.5), 
                     limits = c(1, 5.4)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Tolerant", "Intolerant")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) +
  theme_ag()

## view figure
TC_term_Outcome_p 
```

## Thermal Sensation

### Descriptives

```{r TS_descriptives_Outcome}
jmv::descriptives(
    formula = TS_0 + TS_phase1 + TS_phase2 + TS_term ~ Outcome,
    data = dat,
    iqr = TRUE,
    sw = TRUE)
```

### Test of Difference

non-parametric data:

```{r TS_non-parametric_Outcome}
jmv::ttestIS(
    formula = TS_0 + TS_phase1 + TS_phase2 + TS_term ~ Outcome,
    data = dat,
    vars = vars(TS_0, TS_phase1, TS_phase2, TS_term),
    students = FALSE,
    mann = TRUE,
    eqv = TRUE,
    effectSize = TRUE)
```

### Figure

#### Rest

plot rest figure:  
non-parametric
``` {r TS_rest_Outcome_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TS_rest_Outcome_p <- ggplot(dat, aes(x = Outcome, y = TS_0)) +
  geom_jitter(aes(color = Outcome), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "") +
  scale_y_continuous(breaks = seq(5, 13, 1),
                     limits = c(5, 13)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Tolerant", "Intolerant")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2,
                     label.y = 12) +
  theme_ag()

## view figure
TS_rest_Outcome_p 
```

#### Phase 1

plot delta Phase 1 figure:  
non-parametric

``` {r TS_phase1_Outcome_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TS_phase1_Outcome_p <- ggplot(dat, aes(x = Outcome, y = TS_phase1)) +
  geom_jitter(aes(color = Outcome), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "Δ") +
  scale_y_continuous(breaks = seq(0, 6, 1), 
                     limits = c(0, 6.5)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Tolerant", "Intolerant")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) + 
  theme_ag()

## view figure
TS_phase1_Outcome_p
```

#### Phase 2

plot delta Phase 2 figure:  
non-parametric

``` {r TS_phase2_Outcome_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TS_phase2_Outcome_p <- ggplot(dat, aes(x = Outcome, y = TS_phase2)) +
  geom_jitter(aes(color = Outcome), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "Δ") +
  scale_y_continuous(breaks = seq(-4, 2, 1), 
                     limits = c(-4, 2.5)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Tolerant", "Intolerant")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) + 
  theme_ag()

## view figure
TS_phase2_Outcome_p
```

#### Termination

plot termination figure:  
non-parametric
``` {r TS_termination_Outcome_fig, fig.height = 5, fig.width = 6}
set.seed(123)
TS_term_Outcome_p <- ggplot(dat, aes(x = Outcome, y = TS_term)) +
  geom_jitter(aes(color = Outcome), 
              width = 0.3,
              height = 0,
              alpha = 0.8,
              size = 4,
              shape = 16) +
  stat_summary(fun = median,
               geom="crossbar",
               color="black",
               width = 0.6,
               linewidth = 0.6,
               show.legend = FALSE) +
  stat_summary(fun.data = median_iqr,
               geom="errorbar",
               color="black",
               width = 0.3,
               linewidth = 0.8,
               show.legend = FALSE) +
  labs(x = "Group",
       y = "") +
  scale_y_continuous(breaks = seq(5, 13, 1), 
                     limits = c(5, 14)) +
  scale_color_manual(values = group_cols) +
  stat_compare_means(comparisons = list(c("Tolerant", "Intolerant")),
                     method = "wilcox.test",
                     label = "p.signif",
                     family = "serif",
                     paired = FALSE,
                     bracket.size = 0.6,
                     vjust = -0.2) +
  theme_ag()

## view figure
TS_term_Outcome_p 
```


# Figure Panels

## Patient and Control

### All Data

Patient and control thermophys panel:

```{r perceptuals_panel_class, warning = FALSE, fig.height = 12, fig.width = 15}
row1 <-
  ggarrange(
    RPE_rest_class_p,
    RPE_phase1_class_p,
    RPE_phase2_class_p,
    RPE_term_class_p,
    labels = LETTERS[1:4],
    font.label = list(
      size = 18,
      face = "bold",
      family = "serif"
    ),
    vjust = 1.0,
    ncol = 4
  )

row2 <-
  ggarrange(
    TC_rest_class_p,
    TC_phase1_class_p,
    TC_phase2_class_p,
    TC_term_class_p,
    labels = LETTERS[5:8],
    font.label = list(
      size = 18,
      face = "bold",
      family = "serif"
    ),
    vjust = 1.0,
    ncol = 4
  )

row3 <-
  ggarrange(
    TS_rest_class_p,
    TS_phase1_class_p,
    TS_phase2_class_p,
    TS_term_class_p,
    labels = LETTERS[9:12],
    font.label = list(
      size = 18,
      face = "bold",
      family = "serif"
    ),
    vjust = 1.0,
    ncol = 4
  )

Perceptuals_class_panel <- ggarrange(row1, 
                                     row2, 
                                     row3,
                                     nrow = 3)

## view
Perceptuals_class_panel

ggsave(
  filename = paste0(analysis_dir, "figs/group_perceptuals_panel", ".png"),
  plot = Perceptuals_class_panel,
  height = 12,
  width = 15,
  unit = "in",
  dpi = 600
)

ggsave(
  filename = paste0(analysis_dir, "figs/group_perceptuals_panel", ".jpeg"),
  plot = Perceptuals_class_panel,
  height = 12,
  width = 15,
  unit = "in",
  dpi = 600
)
```

### Annotate 

```{r perceptuals_panel_class_annotate, warning = FALSE, fig.height = 12, fig.width = 15}
## Create combined top annotation using grobTree
top_annotation <- grobTree(
  text_grob(
    "0 minute\n",
    size = 16,
    x = 0.135,
    y = 0,
    hjust = 0.5,
    face = "bold",
    family = "serif"
  ),
  text_grob(
    "Phase 1\n",
    size = 16,
    x = 0.385,
    y = 0,
    hjust = 0.5,
    face = "bold",
    family = "serif"
  ),
  text_grob(
    "Phase 2\n",
    size = 16,
    x = 0.635,
    y = 0,
    hjust = 0.5,
    face = "bold",
    family = "serif"
  ),
  text_grob(
    "Termination\n",
    size = 16,
    x = 0.885,
    y = 0,
    hjust = 0.5,
    face = "bold",
    family = "serif"
  )
)

## Annotate row1
row1ann <- annotate_figure(
  row1,
  left = text_grob(
    "Rating of Percieved Exertion\nScale: 6-20",
    rot = 90,
    size = 16,
    face = "bold",
    family = "serif"
  ),
  top = top_annotation
)

## Annotate row2
row2ann <- annotate_figure(row2,
                           left = text_grob(
                             "Thermal Comfort\nScale: 1.0-5.0",
                             rot = 90,
                             size = 16,
                             face = "bold",
                             family = "serif"
                           ))

## Annotate row3
row3ann <- annotate_figure(row3,
                           left = text_grob(
                             "Thermal Sensation\nScale: 5-13",
                             rot = 90,
                             size = 16,
                             face = "bold",
                             family = "serif"
                           ))

## Combine rows
Perceptuals_class_panel_ann <-
  ggarrange(row1ann, 
            row2ann, 
            row3ann, 
            nrow = 3)
## edit top margin to allow more space top annontations
Perceptuals_class_panel_ann <- Perceptuals_class_panel_ann +
  theme(plot.margin = margin(
    t = 0.4,
    r = 0.2,
    b = 0.2,
    l = 0.2,
    unit = "inches"
  ))
## show panel
Perceptuals_class_panel_ann

ggsave(
  filename = paste0(analysis_dir, "figs/group_perceptuals_panel_annotated", ".png"),
  plot = Perceptuals_class_panel_ann,
  height = 12,
  width = 15,
  unit = "in",
  dpi = 600
)

ggsave(
  filename = paste0(analysis_dir, "figs/group_perceptuals_panel_annotated", ".jpeg"),
  plot = Perceptuals_class_panel_ann,
  height = 12,
  width = 15,
  unit = "in",
  dpi = 600
)
```

## Heat Tolerant and Intolerant

### All Data

```{r perceptuals_panel_outcome, warning = FALSE, fig.height = 12, fig.width = 15}
row1 <-
  ggarrange(
    RPE_rest_Outcome_p,
    RPE_phase1_Outcome_p,
    RPE_phase2_Outcome_p,
    RPE_term_Outcome_p,
    labels = LETTERS[1:4],
    font.label = list(
      size = 18,
      face = "bold",
      family = "serif"
    ),
    vjust = 1.0,
    ncol = 4
  )

row2 <-
  ggarrange(
    TC_rest_Outcome_p,
    TC_phase1_Outcome_p,
    TC_phase2_Outcome_p,
    TC_term_Outcome_p,
    labels = LETTERS[5:8],
    font.label = list(
      size = 18,
      face = "bold",
      family = "serif"
    ),
    vjust = 1.0,
    ncol = 4
  )

row3 <-
  ggarrange(
    TS_rest_Outcome_p,
    TS_phase1_Outcome_p,
    TS_phase2_Outcome_p,
    TS_term_Outcome_p,
    labels = LETTERS[9:12],
    font.label = list(
      size = 18,
      face = "bold",
      family = "serif"
    ),
    vjust = 1.0,
    ncol = 4
  )

Perceptuals_Outcome_panel <- ggarrange(row1, 
                                       row2, 
                                       row3,
                                       nrow = 3)

## view
Perceptuals_Outcome_panel

ggsave(
  filename = paste0(analysis_dir, "figs/outcome_perceptuals_panel", ".png"),
  plot = Perceptuals_Outcome_panel,
  height = 12,
  width = 15,
  unit = "in",
  dpi = 600
)

ggsave(
  filename = paste0(analysis_dir, "figs/outcome_perceptuals_panel", ".jpeg"),
  plot = Perceptuals_Outcome_panel,
  height = 12,
  width = 15,
  unit = "in",
  dpi = 600
)
```

### Annotate 

```{r perceptuals_panel_outcome_annotate, warning = FALSE, fig.height = 12, fig.width = 15}
## Annotate row1
row1ann <- annotate_figure(
  row1,
  left = text_grob(
    "Rating of Percieved Exertion\nScale: 6-20",
    rot = 90,
    size = 16,
    face = "bold",
    family = "serif"
  ),
  top = top_annotation
)

## Annotate row2
row2ann <- annotate_figure(row2,
                           left = text_grob(
                             "Thermal Comfort\nScale: 1.0-5.0",
                             rot = 90,
                             size = 16,
                             face = "bold",
                             family = "serif"
                           ))

## Annotate row3
row3ann <- annotate_figure(row3,
                           left = text_grob(
                             "Thermal Sensation\nScale: 5-13",
                             rot = 90,
                             size = 16,
                             face = "bold",
                             family = "serif"
                           ))


## Combine rows
Perceptuals_Outcome_panel_ann <-
  ggarrange(row1ann, 
            row2ann, 
            row3ann, 
            nrow = 3)
## edit top margin to allow more space top annontations
Perceptuals_Outcome_panel_ann <- Perceptuals_Outcome_panel_ann +
  theme(plot.margin = margin(
    t = 0.4,
    r = 0.2,
    b = 0.2,
    l = 0.2,
    unit = "inches"
  ))
## show panel
Perceptuals_Outcome_panel_ann

ggsave(
  filename = paste0(analysis_dir, "figs/outcome_perceptuals_panel_annotate", ".png"),
  plot = Perceptuals_Outcome_panel_ann,
  height = 12,
  width = 15,
  unit = "in",
  dpi = 600
)

ggsave(
  filename = paste0(analysis_dir, "figs/outcome_perceptuals_panel_annotate", ".jpeg"),
  plot = Perceptuals_Outcome_panel_ann,
  height = 12,
  width = 15,
  unit = "in",
  dpi = 600
)
```

#Session info

``` {r sessionInfo}
sinfo <- sessionInfo()
sinfo
save.image(paste0(analysis_dir, "/HIC_analysis_manuscript_perceptuals.Rout"))
```
